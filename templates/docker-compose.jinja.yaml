{{- "version:" + compose.globals["version"]|string|indent(41,true) }}
{%- set SERVICES = stack.Services %}
{{ "secrets:" }}
{%- for secret in (compose.globals.secrets)|list|sort %}
{{ secret|indent(4, true) + ":" }}
{{ "file:"|indent(8, true) + compose.globals.secrets[secret]['file']|indent(36, true) }}
{%- endfor %}
{%- if compose.globals.volumes is defined and compose.globals.volumes|length > 0 %}
{{ "volumes:" }}{% for volume in compose.globals.volumes|sort %}
{{ volume |indent(4,true) + ":" }}
{{ "external:"|indent(8, true) + "true"|indent(32, true) }}{% endfor %}{% endif %}
{{ "networks:" }}{% for network in compose.globals["networks"]|sort %}
{{ network|indent(4,true) + ":" }}{% if compose.globals["networks"][network]["driver"] is defined %}
{{ "driver:"|indent(8,true) + compose.globals["networks"][network]["driver"]|string|indent(34,true) }}
{%- endif %}{% if compose.globals["networks"][network]["ipam"] is defined %}
{{ "ipam:"|indent(8,true) }}
{{ "config:"|indent(12,true) }}
{{ "- subnet:"|indent(14,true) + compose.globals["networks"][network]["ipam"]["config"][0]["subnet"]|indent(26, true) }}
{%- elif compose.globals["networks"][network]["external"] is defined %}
{{ "external:" |indent(8,true) + compose.globals["networks"][network]["external"]|string|lower|indent(32,true)|default("true") }}
{%- endif %}{% endfor %}
{%- set TRAEFIK_DEFAULTS %}
{{- "- traefik.enable=true"|indent(10, true) }}
{{ "- traefik.frontend.passHostHeader=true"|indent(10,true) }}
{{ "- traefik.frontend.headers.STSPreload=true"|indent(10,true) }}
{{ "- traefik.frontend.headers.frameDeny=true"|indent(10,true) }}
{{ "- traefik.docker.network=frontend"|indent(10,true) }}
{{ "- traefik.frontend.headers.SSLRedirect=true"|indent(10,true) }}
{{ "- traefik.frontend.headers.SSLForceHost=true"|indent(10,true) }}
{{ "- traefik.frontend.headers.browserXSSFilter=true"|indent(10,true) }}
{{ "- traefik.frontend.headers.STSSeconds=315360000"|indent(10,true) }}
{{ "- traefik.frontend.headers.contentTypeNosniff=true"|indent(10,true) }}
{{ "- traefik.frontend.headers.forceSTSHeader=true"|indent(10,true) }}
{{ "- traefik.frontend.headers.customResponseHeaders=X-Robots-Tag:noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex,none"|indent(10,true) }}
{{ "- traefik.frontend.headers.STSIncludeSubdomains=true"| indent(10,true) }}
{%- endset %}
{{ "services:" }}
{%- for service in SERVICES|sort %}
{%- set SERVICE = service|lower|replace("_", "-") %}
{%- set CONTAINER_VPN = ('vpn' in service) %}
{%- if CONTAINER_VPN %}
{{ compose.stackTitle|indent(4, true) + "-" + SERVICE + ":" }}
{{ "container_name:" |indent(8,true) + compose.stackTitle|indent(26, true) + "-" +  SERVICE }}
{{ "hostname:"|indent(8,true) + compose.stackTitle|indent(32, true) + "-" + SERVICE }}
{%- else %}
{{ SERVICE|indent(4, true) + ":" }}
{{ "container_name:"|indent(8, true) + SERVICE|indent(26, true) }}
{%- if not (SERVICES[service]['networks'] and SERVICES[service]['networks']['vpn']) %}
{{ "hostname:"|indent(8, true) + SERVICE|indent(32, true) }}
{%- endif %}
{%- endif %}
{{ "image:"|indent(8, true) + SERVICES[service]['Image']|indent(35,true) + ":" + SERVICES[service]['tags']|default('latest') }}
{%- if SERVICES[service]["init"] is defined %}
{{ "init:"|indent(8, true) + "true"|indent(35,true) }}
{%- endif %}
{%- if SERVICES[service]['build'] and SERVICES[service]['build']['args'][0] is defined %}
{{ "build:"|indent(8, true) + "[]"|indent(29, true) }}
{%- endif %}
{{ "secrets:"|indent(8, true) }}
{%- for secret in SERVICES[service]["secrets"]|sort %}
{{ "- "|indent(10, true) + secret }}
{%- endfor %}
{%- if SERVICES[service]['cap_add'] %}
{{ "cap_add:"|indent(8, true) }}{% for cap in SERVICES[service]['cap_add'] %}
{{ "- "|indent(10, true) + cap }}
{%- endfor %}
{%- endif %}
{%- if SERVICES[service]['cap_drop'] %}
{%- for cap in SERVICES[service]['cap_drop'] %}
{{ "cap_drop:"|indent(8, true) }}
{{ "- "|indent(10, true) + cap }}
{%- endfor %}
{%- endif %}
{%- if 'sysctls' in SERVICES[service] %}
{{ "sysctls:"|indent(8, true) }}{% for statement in SERVICES[service]['sysctls']|sort %}
{{ "- "|indent(10, true)+ "\"" + statement + "\"" }}
{%- endfor %}
{%- endif %}
{%- if SERVICES[service]["privileged"] %}
{{ "privileged:"|indent(8, true) + "true"|indent(30, true) }}
{%- else %}
{{ "user:"|indent(8, true) + "\""|indent(36, true) + compose.puid + ":" + compose.pgid + "\"" }}
{%- endif %}
{{ "env_file:"|indent(8, true) }}
{{ "- globals.env"|indent(10, true) }}
{{ "- "|indent(10, true) + SERVICE + ".env" }}
{%- if SERVICES[service]['Volumes']|length > 0 %}
{{ "volumes:"|indent(8, true) }}
{%- for volume in SERVICES[service]['Volumes']|sort %}
{{ "- "|indent(10, true) + volume }}{% endfor %}{% endif %}{% set FINAL_OCTET = (254 - loop.index)|string %}
{%- if SERVICES[service]['ports'] and not SERVICES[service]['mask_ports'] %}
{{ "ports:"|indent(8, true) }}
{%- for port in SERVICES[service]['ports']|sort %}
{{ "- \""|indent(10,true) + port + "\"" }}
{%- endfor %}
{%- endif %}
{%- if (SERVICES[service]['networks'] and SERVICES[service]['networks']['vpn']) %}
{{ "network_mode:"|indent(8, true) +  "\"service:"|indent(28, true) + compose.vpnHostName + "\"" }}
{%- else %}
{{ "networks:"|indent(8, true) }}
{{ "frontend:"|indent(12, true) }}
{{ "backend:"|indent(12, true) }}
{{ "ipv4_address:" |indent(16,true)  + compose.ip|indent(20,true) + "." + FINAL_OCTET }}
{%- if SERVICES[service]['subdomains'] %}
{{ "dns_search:"|indent(8,true) + SERVICES[service]['subdomains'][0]|indent(30,true) + "." + compose.domain }}
{%- if CONTAINER_VPN %}
{{ "dns:"|indent(8, true) }}
{%- for nameserver in SERVICES[service]['DNS'] %}
{{ "- "|indent(10, true) + nameserver }}
{%- endfor %}
{%- elif ((SERVICES[service]['networks']) and not (SERVICES[service]['networks']['vpn'])) and not (SERVICES[service]['OAUTH_PROXY'] or SERVICES[service]['proxy_secrets']) %}
{{ "domainname:"|indent(8, true) + compose.domain|default("localhost")|indent(30, true) }}
{{ "dns:"|indent(8, true) }}
{%- if not SERVICES[service]['DNS'] %}
{%- for nameserver in defaults.DNS %}
{{ "- "|indent(10, true) + nameserver }}
{%- endfor %}
{%- else %}
{%- for nameserver in SERVICES[service]['DNS'] %}
{{ "- "|indent(10, true) + nameserver }}
{%- endfor %}
{%- endif %}
{%- endif %}
{%- endif %}
{%- if SERVICES[service]['ports'] and SERVICES[service]['subdomains'] and SERVICES[service]['networks'] and SERVICES[service]['networks']['frontend'] or SERVICES[service]['labels'] %}
{{ "labels:"|indent(8,true) }}
{%- if CONTAINER_VPN %}
{{ "- "|indent(10,true) + SERVICE + "-" + "service.name=" + compose.stackTitle + "-" + SERVICE }}{% else %}
{{ "- "|indent(10,true) + "service.name=" + SERVICE }}
{%- endif %}
{%- if SERVICES[service]['ports'] and SERVICES[service]['subdomains'] and SERVICES[service]['networks'] and SERVICES[service]['networks']['frontend'] and not SERVICES[service]['OAUTH_PROXY'] and not SERVICES[service]['proxy_secrets'] %}
{{ TRAEFIK_DEFAULTS }}
{{ "- traefik.frontend.headers.customFrameOptionsValue='sameorigin','allow-from https://"|indent(10,true) + compose.organizrURL + ",https://" + SERVICES[service]['subdomains'][0] + "." + compose.domain + "'" }}
{%- if SERVICES[service]['HOSTS'] and ',' in SERVICES[service]['HOSTS'] %}
{{ "- traefik."|indent(10,true) + SERVICE + ".frontend.rule=Host:" + SERVICES[service]['HOSTS']|lower }}
{%- else %}
{{ "- traefik."|indent(10,true) + SERVICE + ".frontend.rule=Host:" + SERVICES[service]['subdomains'][0] }}
{%- endif %}
{{ "- traefik.frontend.headers.SSLHost="|indent(10,true) + SERVICES[service]['subdomains'][0] + "." + compose.domain  }}
{{ "- traefik.backend="|indent(10,true) + SERVICE }}
{%- if service|string == "nextcloud" %}
{{ ("- traefik."|indent(10,true) + SERVICE + ".protocol=https")|string }}
{%- else %}
{{ ("- traefik."|indent(10,true) + SERVICE + ".protocol=http")|string }}
{%- endif %}
{%- if SERVICE== "plex" %}
{{ ("- traefik."|indent(10,true) + SERVICE + ".port=32400")|string }}
{%- else %}
{{ ("- traefik."|indent(10,true) + SERVICE + ".port=" + SERVICES[service]['ports'][0].split(':')[1])|string }}
{%- endif %}
{%- endif %}
{%- if SERVICES[service]['labels'] %}
{%- for label in SERVICES[service]['labels'] %}
{{ "- "|indent(10, true) + label }}
{%- endfor %}
{%- endif %}
{%- endif %}
{%- if 'Commands' in SERVICES[service] and SERVICES[service]['Commands'][0] is defined %}
{{ "command:"|indent(8,true)}}{% for command in SERVICES[service]['Commands']|sort %}
{%- if SERVICES[service]['Commands']|length == 1 %}
{{- "\""|indent(33, true) + command + "\"" }}
{%- else %}
{{ "- \""|indent(10, true) + command + "\"" }}
{%- endif %}
{%- endfor%}
{%- endif %}
{%- if ('depends_on' in SERVICES[service] and SERVICES[service]['depends_on']) or (SERVICES[service]['networks'] and SERVICES[service]['networks']['vpn']) %}
{{ "depends_on:"|indent(8,true)}}
{%- for dependency in SERVICES[service]['depends_on'] %}{% if dependency|string|lower != service|string|lower %}
{{ "- \""|indent(10, true) + dependency|replace("_", "-") + "\"" }}{% endif %}{% endfor %}
{%- if SERVICES[service]['networks'] and SERVICES[service]['networks']['vpn'] %}
{{ "- \""|indent(10, true) + compose.vpnHostName + "\"" }}
{%- endif %}
{%- endif %}
{%- if 'healthcheck' in SERVICES[service] and SERVICES[service]['healthcheck'] %}
{{ "healthcheck:"|indent(8, true) }}
{{ "test:"|indent(12,true) + SERVICES[service]['healthcheck']['test']|indent(36, true) }}
{{ "interval:"|indent(12,true) + SERVICES[service]['healthcheck']['interval']|default(30, true) + "s" }}
{{ "timeout:"|indent(12,true) + SERVICES[service]['healthcheck']['timeout']|default(30, true) + "s" }}
{{ "retries:"|indent(12,true) + SERVICES[service]['healthcheck']['retries']|default(5, true) }}
{%- endif %}
{%- if 'entrypoint' in SERVICES[service] %}
{{ "entrypoint:"|indent(8, true) + "|"|indent(30, true) }}
{{ "bash -c 'bash -s <<EOF"|indent(12, true) }}{% for entry in SERVICES[service]["entrypoint"] %}
{{ entry|indent(16, true) }}{% endfor %}
{{ "EOF'"|indent(12, true) }}
{%- endif %}
{%- if ((SERVICES[service]['OAUTH_PROXY'] or SERVICES[service]['proxy_secrets']) is defined) %}
{{ SERVICE|indent(4,true) + "-proxy:" }}
{{ "container_name:"|indent(8, true) + SERVICE|indent(26,true) + "-proxy" }}
{{ "image:"|indent(8, true) + "a5huynh/oauth2_proxy:latest"|indent(35,true) }}
{{ "secrets:"|indent(8, true) }}
{%- for secret in SERVICES[service]["secrets"]|sort %}
{{ "- "|indent(10, true) + secret }}
{%- endfor %}
{{ "env_file:"|indent(8, true) }}
{{ "- globals.env"|indent(10, true) }}
{{ "- "|indent(10, true) + SERVICE + ".env" }}
{{ "volumes:"|indent(8, true) }}
{{ "- "|indent(10, true) + compose.authenticatedEmailsFile + ":" + compose.authenticatedEmailsContainerPath + ":ro" }}
{{ "user:"|indent(8, true) + "\""|indent(36, true) + compose.puid + ":" + compose.pgid + "\"" }}
{%- if (SERVICES[service]['networks'] and SERVICES[service]['networks']['vpn']) %}
{{ "network_mode:"|indent(8, true) +  "\"service:"|indent(28, true) + compose.vpnHostName + "\"" }}
{%- else %}
{{ "networks:"|indent(8, true) }}
{{ "- backend"|indent(10,true) }}
{{ "- frontend"|indent(10,true) }}
{%- if SERVICES[service]['subdomains'] is defined %}
{{ "dns_search:"|indent(8,true) + SERVICES[service]['subdomains'][0]|indent(30,true) + "." + compose.domain }}
{{ "dns:"|indent(8, true) }}
{%- for nameserver in defaults.DNS %}
{{ "- "|indent(10, true) + nameserver }}
{%- endfor %}
{%- else %}
{%- for nameserver in SERVICES[service]['DNS'] %}
{{ "-"|indent(10, true) + nameserver }}
{%- endfor %}
{%- endif %}
{%- endif %}
{{ "restart:"|indent(8,true) + "always"|indent(33,true) }}
{{ "depends_on:"|indent(8, true) }}
{{ "- "|indent(10, true) + SERVICE}}
{{ "labels:"|indent(8,true) }}
{{ "- traefik."|indent(10,true) + SERVICE + ".frontend.rule=Host:" + SERVICES[service]['subdomains'][0]|lower + "." + compose.domain }}
{{ "- traefik.frontend.headers.customFrameOptionsValue='SAMEORIGIN','"|indent(10,true) + "allow-from https://" + compose.organizrURL + ",https://" + SERVICES[service]['subdomains'][0] + "." + compose.domain + "'" }}
{{ "- traefik.frontend.headers.SSLHost="|indent(10,true) + SERVICES[service]['subdomains'][0] + "." + compose.domain }}
{%- if (SERVICES[service]['networks'] and SERVICES[service]['networks']['vpn']) %}
{{ "- traefik.backend="|indent(10,true) + compose.vpnHostName }}{% else %}
{{ "- traefik.backend="|indent(10,true) + SERVICE + "-proxy" }}
{{ "- traefik."|indent(10,true) + SERVICE + ".port=" + compose.oauth_port }}
{%- endif %}
{{ TRAEFIK_DEFAULTS }}
{{ "command:"|indent(8, true) + "|"|indent(32, true) }}
{{ "-cookie-secure=false"|indent(10, true) }}
{{ "-authenticated-emails-file="|indent(10, true) + compose.authenticatedEmailsContainerPath }}
{{ "-email-domain=gmail.com"|indent(10, true) }}
{%- if SERVICES[service]['networks'] is defined and SERVICES[service]['networks']['vpn'] and SERVICES[service]['ports'] %}
{{ "-upstream=http://"|indent(10, true) + compose.vpnHostName + ":" + SERVICES[service]['ports'][0].split(':')[1] }}
{%- elif SERVICES[service]['ports']  %}
{{ "-upstream=http://"|indent(10, true) + SERVICE|replace("_", "-") + ":" + SERVICES[service]['ports'][0].split(':')[1] }}
{%- elif SERVICES[service]['networks'] is defined and SERVICES[service]['networks']["frontend"] and not SERVICES[service]['ports'] %}
{{ "-upstream=http://"|indent(10, true) + SERVICE|replace("_", "-") + ":" + 80 }}
{%- endif %}
{{ "-http-address=http://0.0.0.0:"|indent(10, true) + compose.oauth_port }}
{{ "-provider=github"|indent(10, true) }}
{%- if SERVICES[service]['subdomains'] is defined %}
{{ "-redirect-url=https://"|indent(10, true) + SERVICES[service]['subdomains'][0] + "." + compose.domain }}
{%- else %}
{{ "-redirect-url=https://"|indent(10, true) + SERVICE + "." + compose.domain }}
{%- endif %}
{%- endif %}
{%- endif %}
{%- endfor %}
